<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestPro - Gestion d'Entreprise</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#0d9488;--primary-dark:#0f766e;--primary-light:#99f6e4;--success:#10b981;--success-light:#d1fae5;--warning:#f59e0b;--warning-light:#fef3c7;--danger:#ef4444;--danger-light:#fee2e2;--dark:#1e293b;--gray:#64748b;--light:#f1f5f9;--white:#fff;--radius:12px}
        body{font-family:'Plus Jakarta Sans',sans-serif;background:linear-gradient(135deg,#f8fafc,#e2e8f0);min-height:100vh;color:var(--dark)}
        .app{display:flex;min-height:100vh}
        .sidebar{width:250px;background:linear-gradient(180deg,var(--dark),#334155);position:fixed;height:100vh;z-index:100;display:flex;flex-direction:column}
        .sidebar-header{padding:20px;border-bottom:1px solid rgba(255,255,255,.1)}
        .logo{display:flex;align-items:center;gap:12px}
        .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
        .logo-text{color:#fff;font-size:20px;font-weight:700}
        .sidebar-nav{flex:1;padding:16px 12px;overflow-y:auto}
        .nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;color:#94a3b8;border-radius:8px;margin-bottom:4px;cursor:pointer;font-weight:500;transition:.2s}
        .nav-item:hover{background:rgba(255,255,255,.08);color:#fff}
        .nav-item.active{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 4px 12px rgba(13,148,136,.4)}
        .nav-item svg{width:20px;height:20px}
        .sidebar-footer{padding:16px 20px;border-top:1px solid rgba(255,255,255,.1);color:#94a3b8;font-size:12px}
        .main{flex:1;margin-left:250px}
        .header{height:60px;background:var(--white);border-bottom:1px solid var(--light);display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:50;box-shadow:0 2px 4px rgba(0,0,0,.05)}
        .header-title{font-weight:600;font-size:18px}
        .content{padding:24px}
        .page{animation:fadeIn .3s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
        .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
        .page-title{font-size:26px;font-weight:700}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;transition:.2s;font-family:inherit}
        .btn svg{width:18px;height:18px}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 4px 12px rgba(13,148,136,.3)}
        .btn-primary:hover{transform:translateY(-2px)}
        .btn-secondary{background:var(--light);color:var(--dark)}
        .btn-success{background:var(--success);color:#fff}
        .btn-sm{padding:8px 14px;font-size:13px}
        .btn-icon{width:36px;height:36px;padding:0;border:none;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
        .btn-edit{background:var(--primary-light);color:var(--primary-dark)}
        .btn-edit:hover{background:var(--primary);color:#fff}
        .btn-delete{background:var(--danger-light);color:var(--danger)}
        .btn-delete:hover{background:var(--danger);color:#fff}
        .search-bar{display:flex;align-items:center;gap:12px;background:var(--white);border:2px solid var(--light);border-radius:var(--radius);padding:12px 16px;margin-bottom:20px}
        .search-bar:focus-within{border-color:var(--primary)}
        .search-bar input{flex:1;border:none;outline:none;font-size:15px;font-family:inherit}
        .table-box{background:var(--white);border-radius:var(--radius);box-shadow:0 4px 6px rgba(0,0,0,.1);overflow-x:auto}
        table{width:100%;border-collapse:collapse;min-width:600px}
        th{background:var(--light);padding:14px 16px;text-align:left;font-weight:600;font-size:12px;color:var(--gray);text-transform:uppercase}
        td{padding:14px 16px;border-bottom:1px solid var(--light);font-size:14px}
        tr:hover{background:#f8fafc}
        .text-success{color:var(--success)}
        .text-warning{color:var(--warning)}
        .text-danger{color:var(--danger)}
        .badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
        .badge-success{background:var(--success-light);color:var(--success)}
        .badge-warning{background:var(--warning-light);color:var(--warning)}
        .badge-danger{background:var(--danger-light);color:var(--danger)}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;opacity:0;visibility:hidden;transition:.3s}
        .modal-overlay.active{opacity:1;visibility:visible}
        .modal{background:var(--white);border-radius:var(--radius);width:100%;max-width:600px;max-height:90vh;overflow-y:auto}
        .modal-lg{max-width:800px}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--light)}
        .modal-header h2{font-size:18px}
        .modal-close{background:none;border:none;cursor:pointer;color:var(--gray);font-size:24px}
        .modal-body{padding:20px}
        .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
        .form-group{display:flex;flex-direction:column;gap:6px}
        .form-group.full{grid-column:1/-1}
        .form-group label{font-weight:600;font-size:13px}
        .form-group input,.form-group select,.form-group textarea{padding:10px 12px;border:2px solid var(--light);border-radius:8px;font-size:14px;font-family:inherit}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary)}
        .form-actions{display:flex;justify-content:flex-end;gap:12px;margin-top:20px;padding-top:16px;border-top:1px solid var(--light)}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:24px}
        .stat-card{background:var(--white);border-radius:var(--radius);padding:20px;display:flex;align-items:center;gap:16px;box-shadow:0 4px 6px rgba(0,0,0,.1)}
        .stat-icon{width:50px;height:50px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff}
        .stat-icon.primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark))}
        .stat-icon.success{background:linear-gradient(135deg,#10b981,#059669)}
        .stat-icon.danger{background:linear-gradient(135deg,#ef4444,#dc2626)}
        .stat-icon.warning{background:linear-gradient(135deg,#f59e0b,#d97706)}
        .stat-label{font-size:13px;color:var(--gray)}
        .stat-value{font-size:22px;font-weight:700}
        .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
        .card{background:var(--white);border-radius:var(--radius);padding:20px;box-shadow:0 4px 6px rgba(0,0,0,.1)}
        .card h3{font-size:15px;margin-bottom:16px}
        .alert-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--warning-light);border-radius:8px;margin-bottom:8px;font-size:13px}
        .recent-item{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--light);font-size:13px}
        .tresorerie-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px}
        .summary-card{background:var(--white);border-radius:var(--radius);padding:20px;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,.1)}
        .summary-card.entree{border-top:4px solid var(--success)}
        .summary-card.sortie{border-top:4px solid var(--danger)}
        .summary-card.solde{border-top:4px solid var(--primary)}
        .summary-label{font-size:13px;color:var(--gray);margin-bottom:8px}
        .summary-value{font-size:22px;font-weight:700}
        .summary-card.entree .summary-value{color:var(--success)}
        .summary-card.sortie .summary-value{color:var(--danger)}
        .summary-card.solde .summary-value{color:var(--primary)}
        .toast-box{position:fixed;top:80px;right:20px;z-index:9999}
        .toast{padding:14px 20px;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:12px;min-width:300px;color:#fff;animation:slideIn .3s}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .toast.success{background:var(--success)}
        .toast.error{background:var(--danger)}
        .toast.warning{background:var(--warning)}
        .rapports-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
        .rapport-card{background:var(--white);border-radius:var(--radius);padding:24px;box-shadow:0 4px 6px rgba(0,0,0,.1);text-align:center;cursor:pointer;transition:.2s}
        .rapport-card:hover{transform:translateY(-4px);box-shadow:0 8px 16px rgba(0,0,0,.15)}
        .rapport-card svg{width:48px;height:48px;color:var(--primary);margin-bottom:16px}
        .rapport-card h4{font-size:16px;margin-bottom:8px}
        .rapport-card p{font-size:13px;color:var(--gray)}
        @media(max-width:768px){.sidebar{display:none}.main{margin-left:0}.stats-grid{grid-template-columns:1fr}.form-grid{grid-template-columns:1fr}.tresorerie-summary{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div id="app"></div>
<div id="toast-box" class="toast-box"></div>
<script>
// ========== CONFIGURATION SUPABASE ==========
// Option 1: Mettre tes cl√©s directement ici
const SUPABASE_URL = 'https://xxxxxxxxxxxx.supabase.co';  // Remplace par ton URL
const SUPABASE_KEY = 'eyJxxxxxxxxxxxx';  // Remplace par ta cl√© anon/public

// Initialisation Supabase
let db = null;
let useDatabase = false;

function initSupabase() {
    if (SUPABASE_URL && SUPABASE_URL !== 'https://xxxxxxxxxxxx.supabase.co' && SUPABASE_KEY) {
        try {
            db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            useDatabase = true;
            console.log('‚úÖ Supabase connect√©');
        } catch(e) {
            console.error('‚ùå Erreur Supabase:', e);
        }
    } else {
        console.log('‚ÑπÔ∏è Mode d√©mo (donn√©es locales)');
    }
}
initSupabase();

// ========== UTILITAIRES ==========
const formatFCFA = m => new Intl.NumberFormat('fr-SN').format(m||0) + ' FCFA';
const formatDate = d => d ? new Date(d).toLocaleDateString('fr-FR') : '-';
const genId = () => Math.random().toString(36).substr(2, 9);
const today = () => new Date().toISOString().split('T')[0];

// ========== TOAST ==========
const toast = {
    show(msg, type='success') {
        const box = document.getElementById('toast-box');
        const id = genId();
        box.innerHTML += `<div class="toast ${type}" id="t${id}">${msg}</div>`;
        setTimeout(() => document.getElementById('t'+id)?.remove(), 4000);
    },
    success(m) { this.show(m, 'success'); },
    error(m) { this.show(m, 'error'); },
    warning(m) { this.show(m, 'warning'); }
};

// ========== HELPERS ==========
const genCode = prefix => prefix + '-' + String(Math.floor(Math.random() * 9000) + 1000);
const getYear = d => d ? new Date(d).getFullYear() : new Date().getFullYear();
const getTypeBadge = type => {
    const cls = { entreprise: 'badge-info', particulier: 'badge-success', association: 'badge-warning' };
    return `<span class="badge ${cls[type]||'badge-success'}">${type||'particulier'}</span>`;
};

// ========== DONN√âES ==========
let data = {
    entreprise: { nom: 'Mon Entreprise', adresse: 'Dakar, S√©n√©gal', telephone: '+221 77 000 00 00' },
    clients: [
        { id: '1', code: 'CLI-0001', nom: 'Amadou Diallo', type: 'particulier', telephone: '+221 77 123 45 67', email: 'amadou@email.com', adresse: 'Dakar', ninea: '', contact: '' },
        { id: '2', code: 'CLI-0002', nom: 'SENELEC SA', type: 'entreprise', telephone: '+221 33 800 00 00', email: 'contact@senelec.sn', adresse: 'Dakar', ninea: '12345678A', contact: 'Fatou Sow - DG' },
        { id: '3', code: 'CLI-0003', nom: 'Association Jeunesse', type: 'association', telephone: '+221 76 345 67 89', email: '', adresse: 'Saint-Louis', ninea: '', contact: 'Moussa Ndiaye' },
    ],
    fournisseurs: [
        { id: '1', code: 'FRN-0001', nom: 'SENEGAL DISTRIBUTION', type: 'entreprise', telephone: '+221 33 800 00 00', adresse: 'Dakar', ninea: '98765432B', contact: 'Ibrahim Fall' },
        { id: '2', code: 'FRN-0002', nom: 'TOUBA TRADING', type: 'entreprise', telephone: '+221 33 900 00 00', adresse: 'Touba', ninea: '45678901C', contact: 'Modou Diop' },
    ],
    categories: [
        { id: '1', nom: 'Alimentation' },
        { id: '2', nom: 'Boissons' },
        { id: '3', nom: '√âlectronique' },
    ],
    produits: [
        { id: '1', ref: 'PRD001', nom: 'Riz Bris√© 25kg', catId: '1', prixAchat: 12000, prixVente: 15000, stock: 8, stockMin: 10 },
        { id: '2', ref: 'PRD002', nom: 'Huile V√©g√©tale 20L', catId: '1', prixAchat: 18000, prixVente: 22000, stock: 30, stockMin: 5 },
        { id: '3', ref: 'PRD003', nom: 'Coca Cola Pack 24', catId: '2', prixAchat: 8000, prixVente: 10000, stock: 3, stockMin: 10 },
        { id: '4', ref: 'PRD004', nom: 'T√©l√©phone Basique', catId: '3', prixAchat: 15000, prixVente: 20000, stock: 15, stockMin: 5 },
    ],
    ventes: [
        { id: '1', num: 'VTE-2025-001', date: '2025-01-10', clientId: '1', lignes: [{prodId:'1',qte:2,pu:15000}], total: 30000, paye: 30000, statut: 'pay√©e', paiements: [{date:'2025-01-10',montant:30000,mode:'esp√®ces'}] },
        { id: '2', num: 'VTE-2025-002', date: '2025-01-12', clientId: '2', lignes: [{prodId:'2',qte:1,pu:22000},{prodId:'3',qte:2,pu:10000}], total: 42000, paye: 20000, statut: 'partielle', paiements: [{date:'2025-01-12',montant:20000,mode:'virement'}] },
        { id: '3', num: 'VTE-2025-003', date: '2025-01-13', clientId: '3', lignes: [{prodId:'4',qte:3,pu:20000}], total: 60000, paye: 0, statut: 'impay√©e', paiements: [] },
    ],
    achats: [
        { id: '1', num: 'ACH-2025-001', date: '2025-01-08', fournId: '1', lignes: [{prodId:'1',qte:20,pu:12000}], total: 240000, paye: 240000, statut: 'pay√©', paiements: [{date:'2025-01-08',montant:240000,mode:'virement'}] },
        { id: '2', num: 'ACH-2025-002', date: '2025-01-09', fournId: '2', lignes: [{prodId:'2',qte:10,pu:18000}], total: 180000, paye: 100000, statut: 'partiel', paiements: [{date:'2025-01-09',montant:100000,mode:'esp√®ces'}] },
    ],
    tresorerie: [
        { id: '1', date: '2025-01-05', type: 'entree', cat: 'Apport', desc: 'Capital initial', montant: 500000, mode: 'esp√®ces' },
        { id: '2', date: '2025-01-08', type: 'sortie', cat: 'Achat', desc: 'Paiement ACH-2025-001', montant: 240000, mode: 'virement' },
        { id: '3', date: '2025-01-09', type: 'sortie', cat: 'Achat', desc: 'Acompte ACH-2025-002', montant: 100000, mode: 'esp√®ces' },
        { id: '4', date: '2025-01-10', type: 'entree', cat: 'Vente', desc: 'VTE-2025-001', montant: 30000, mode: 'esp√®ces' },
        { id: '5', date: '2025-01-12', type: 'entree', cat: 'Vente', desc: 'Acompte VTE-2025-002', montant: 20000, mode: 'virement' },
    ],
    employes: [
        { id: '1', matricule: 'EMP001', nom: 'Diop', prenom: 'Ibrahima', poste: 'G√©rant', salaire: 350000 },
        { id: '2', matricule: 'EMP002', nom: 'Ndiaye', prenom: 'Mariama', poste: 'Vendeuse', salaire: 150000 },
    ]
};

let state = { page: 'dashboard', search: '', editing: null, filterYear: new Date().getFullYear(), filterDateStart: '', filterDateEnd: '' };

function filterByDate(items, dateField = 'date') {
    let filtered = items;
    if (state.filterYear) filtered = filtered.filter(item => getYear(item[dateField]) === parseInt(state.filterYear));
    if (state.filterDateStart) filtered = filtered.filter(item => item[dateField] >= state.filterDateStart);
    if (state.filterDateEnd) filtered = filtered.filter(item => item[dateField] <= state.filterDateEnd);
    return filtered;
}

function getYears() {
    const years = new Set();
    data.ventes.forEach(v => years.add(getYear(v.date)));
    data.achats.forEach(a => years.add(getYear(a.date)));
    data.tresorerie.forEach(t => years.add(getYear(t.date)));
    years.add(new Date().getFullYear());
    return Array.from(years).sort((a, b) => b - a);
}

// ========== IC√îNES ==========
const ic = {
    dashboard: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
    clients: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>',
    fournisseurs: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>',
    produits: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8l-7-4-7 4v8l7 4 7-4z"/><path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/></svg>',
    ventes: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
    achats: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>',
    tresorerie: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>',
    rapports: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
    employes: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',
    plus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
    edit: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
    delete: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
    search: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
    download: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
    pdf: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>',
    warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
};

// ========== EXPORT EXCEL ==========
const excel = {
    export(arr, filename) {
        const ws = XLSX.utils.json_to_sheet(arr);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Donn√©es');
        XLSX.writeFile(wb, filename + '_' + today() + '.xlsx');
        toast.success('Export Excel: ' + filename);
    },
    clients() { this.export(data.clients.map(c=>({Nom:c.nom,T√©l√©phone:c.telephone,Email:c.email||'',Adresse:c.adresse})), 'Clients'); },
    fournisseurs() { this.export(data.fournisseurs.map(f=>({Nom:f.nom,T√©l√©phone:f.telephone,Adresse:f.adresse})), 'Fournisseurs'); },
    produits() { 
        this.export(data.produits.map(p=>({R√©f√©rence:p.ref,Nom:p.nom,PrixAchat:p.prixAchat,PrixVente:p.prixVente,Marge:p.prixVente-p.prixAchat,Stock:p.stock,ValeurStock:p.stock*p.prixAchat})), 'Produits'); 
    },
    ventes() { 
        this.export(data.ventes.map(v=>{
            const cl = data.clients.find(c=>c.id===v.clientId);
            return {Num√©ro:v.num,Date:v.date,Client:cl?.nom||'',Total:v.total,Pay√©:v.paye,Reste:v.total-v.paye,Statut:v.statut};
        }), 'Ventes'); 
    },
    achats() {
        this.export(data.achats.map(a=>{
            const f = data.fournisseurs.find(x=>x.id===a.fournId);
            return {Num√©ro:a.num,Date:a.date,Fournisseur:f?.nom||'',Total:a.total,Pay√©:a.paye,Reste:a.total-a.paye,Statut:a.statut};
        }), 'Achats');
    },
    tresorerie() {
        this.export(data.tresorerie.map(t=>({Date:t.date,Type:t.type==='entree'?'Entr√©e':'Sortie',Cat√©gorie:t.cat,Description:t.desc,Montant:t.type==='entree'?t.montant:-t.montant,Mode:t.mode})), 'Tresorerie');
    },
    employes() { this.export(data.employes.map(e=>({Matricule:e.matricule,Nom:e.nom,Pr√©nom:e.prenom,Poste:e.poste,Salaire:e.salaire})), 'Employes'); },
    rapportComplet() {
        const wb = XLSX.utils.book_new();
        const totalV = data.ventes.reduce((s,v)=>s+v.total,0);
        const totalA = data.achats.reduce((s,a)=>s+a.total,0);
        const entrees = data.tresorerie.filter(t=>t.type==='entree').reduce((s,t)=>s+t.montant,0);
        const sorties = data.tresorerie.filter(t=>t.type==='sortie').reduce((s,t)=>s+t.montant,0);
        const valStock = data.produits.reduce((s,p)=>s+p.stock*p.prixAchat,0);
        const resume = [{Indicateur:'Total Ventes',Valeur:totalV},{Indicateur:'Total Achats',Valeur:totalA},{Indicateur:'Marge',Valeur:totalV-totalA},{Indicateur:'Entr√©es',Valeur:entrees},{Indicateur:'Sorties',Valeur:sorties},{Indicateur:'Solde Tr√©sorerie',Valeur:entrees-sorties},{Indicateur:'Valeur Stock',Valeur:valStock}];
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(resume), 'R√©sum√©');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.clients), 'Clients');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.produits), 'Produits');
        XLSX.writeFile(wb, 'Rapport_Complet_' + today() + '.xlsx');
        toast.success('Rapport complet export√©!');
    }
};

// ========== PDF ==========
const pdf = {
    facture(v) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const cl = data.clients.find(c=>c.id===v.clientId);
        doc.setFontSize(20);
        doc.setTextColor(13,148,136);
        doc.text(data.entreprise.nom, 20, 20);
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.text(data.entreprise.adresse, 20, 28);
        doc.text(data.entreprise.telephone, 20, 34);
        doc.setFontSize(24);
        doc.setTextColor(30,41,59);
        doc.text('FACTURE', 190, 20, {align:'right'});
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text('N¬∞ ' + v.num, 190, 28, {align:'right'});
        doc.text('Date: ' + formatDate(v.date), 190, 35, {align:'right'});
        doc.setFillColor(241,245,249);
        doc.roundedRect(20, 50, 80, 25, 3, 3, 'F');
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.text('CLIENT:', 25, 58);
        doc.setFontSize(12);
        doc.setTextColor(30);
        doc.text(cl?.nom || 'Client', 25, 66);
        const rows = v.lignes.map((l,i)=>{
            const p = data.produits.find(x=>x.id===l.prodId);
            return [i+1, p?.nom||'Produit', l.qte, formatFCFA(l.pu), formatFCFA(l.qte*l.pu)];
        });
        doc.autoTable({startY:85,head:[['#','D√©signation','Qt√©','P.U.','Montant']],body:rows,theme:'striped',headStyles:{fillColor:[13,148,136]}});
        const y = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(14);
        doc.setTextColor(13,148,136);
        doc.text('TOTAL: ' + formatFCFA(v.total), 190, y, {align:'right'});
        if(v.paye>0){doc.setFontSize(10);doc.setTextColor(16,185,129);doc.text('Pay√©: '+formatFCFA(v.paye),190,y+8,{align:'right'});}
        if(v.total-v.paye>0){doc.setTextColor(239,68,68);doc.text('Reste: '+formatFCFA(v.total-v.paye),190,y+14,{align:'right'});}
        doc.save('Facture_'+v.num+'.pdf');
        toast.success('Facture PDF g√©n√©r√©e!');
    }
};

// ========== MODAL ==========
let modal = { open: false, content: '', size: '' };
function openModal(content, size='') { modal = {open:true, content, size}; render(); }
function closeModal() { modal.open = false; render(); }

// ========== NAVIGATION ==========
function nav(page) { state.page = page; state.search = ''; render(); }

// ========== RENDU ==========
function render() {
    const app = document.getElementById('app');
    app.innerHTML = `
        <div class="app">
            <aside class="sidebar">
                <div class="sidebar-header"><div class="logo"><div class="logo-icon">GP</div><span class="logo-text">GestPro</span></div></div>
                <nav class="sidebar-nav">
                    ${navItem('dashboard','Tableau de bord',ic.dashboard)}
                    ${navItem('clients','Clients',ic.clients)}
                    ${navItem('fournisseurs','Fournisseurs',ic.fournisseurs)}
                    ${navItem('produits','Produits',ic.produits)}
                    ${navItem('ventes','Ventes',ic.ventes)}
                    ${navItem('achats','Achats',ic.achats)}
                    ${navItem('tresorerie','Tr√©sorerie',ic.tresorerie)}
                    ${navItem('rapports','Rapports Excel',ic.rapports)}
                    ${navItem('employes','Employ√©s',ic.employes)}
                </nav>
                <div class="sidebar-footer">${data.entreprise.nom}<br>${data.entreprise.adresse}</div>
            </aside>
            <main class="main">
                <header class="header"><span class="header-title">${getTitle()}</span></header>
                <div class="content">${renderPage()}</div>
            </main>
        </div>
        <div class="modal-overlay ${modal.open?'active':''}" onclick="closeModal()">
            <div class="modal ${modal.size}" onclick="event.stopPropagation()">${modal.content}</div>
        </div>
    `;
}

function navItem(id, label, icon) {
    return `<div class="nav-item ${state.page===id?'active':''}" onclick="nav('${id}')">${icon}<span>${label}</span></div>`;
}

function getTitle() {
    const t = {dashboard:'Tableau de bord',clients:'Clients',fournisseurs:'Fournisseurs',produits:'Produits',ventes:'Ventes',achats:'Achats',tresorerie:'Tr√©sorerie',rapports:'Rapports Excel',employes:'Employ√©s'};
    return t[state.page] || 'GestPro';
}

function renderPage() {
    switch(state.page) {
        case 'dashboard': return pageDashboard();
        case 'clients': return pageClients();
        case 'fournisseurs': return pageFournisseurs();
        case 'produits': return pageProduits();
        case 'ventes': return pageVentes();
        case 'achats': return pageAchats();
        case 'tresorerie': return pageTresorerie();
        case 'rapports': return pageRapports();
        case 'employes': return pageEmployes();
        default: return pageDashboard();
    }
}

// ========== PAGES ==========
function pageDashboard() {
    const totalV = data.ventes.reduce((s,v)=>s+v.total,0);
    const totalA = data.achats.reduce((s,a)=>s+a.total,0);
    const entrees = data.tresorerie.filter(t=>t.type==='entree').reduce((s,t)=>s+t.montant,0);
    const sorties = data.tresorerie.filter(t=>t.type==='sortie').reduce((s,t)=>s+t.montant,0);
    const solde = entrees - sorties;
    const valStock = data.produits.reduce((s,p)=>s+p.stock*p.prixAchat,0);
    const impayees = data.ventes.filter(v=>v.statut!=='pay√©e').reduce((s,v)=>s+(v.total-v.paye),0);
    const stockBas = data.produits.filter(p=>p.stock<=p.stockMin);
    
    const totalPaye = data.ventes.reduce((s,v)=>s+v.paye,0);
    const tauxRecouvrement = totalV > 0 ? Math.round((totalPaye / totalV) * 100) : 0;
    const marge = totalV - totalA;
    const tauxMarge = totalV > 0 ? Math.round((marge / totalV) * 100) : 0;
    
    return `<div class="page">
        <h1 class="page-title">üìä Tableau de Bord</h1>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-icon primary">${ic.tresorerie}</div><div><div class="stat-label">Solde Tr√©sorerie</div><div class="stat-value" style="color:${solde>=0?'var(--success)':'var(--danger)'}">${formatFCFA(solde)}</div></div></div>
            <div class="stat-card"><div class="stat-icon success">${ic.ventes}</div><div><div class="stat-label">Total Ventes</div><div class="stat-value">${formatFCFA(totalV)}</div></div></div>
            <div class="stat-card"><div class="stat-icon danger">${ic.achats}</div><div><div class="stat-label">Total Achats</div><div class="stat-value">${formatFCFA(totalA)}</div></div></div>
            <div class="stat-card"><div class="stat-icon warning">${ic.produits}</div><div><div class="stat-label">Valeur Stock</div><div class="stat-value">${formatFCFA(valStock)}</div></div></div>
        </div>
        <div class="stats-grid" style="grid-template-columns:repeat(3,1fr)">
            <div class="stat-card"><div style="text-align:center;width:100%"><div class="stat-label">üìà Taux de Recouvrement</div><div class="stat-value" style="color:${tauxRecouvrement>=80?'var(--success)':tauxRecouvrement>=50?'var(--warning)':'var(--danger)'}">${tauxRecouvrement}%</div><div style="background:var(--light);height:8px;border-radius:4px;margin-top:10px;overflow:hidden"><div style="background:${tauxRecouvrement>=80?'var(--success)':tauxRecouvrement>=50?'var(--warning)':'var(--danger)'};width:${tauxRecouvrement}%;height:100%"></div></div></div></div>
            <div class="stat-card"><div style="text-align:center;width:100%"><div class="stat-label">üíµ Marge Brute</div><div class="stat-value" style="color:${marge>=0?'var(--success)':'var(--danger)'}">${formatFCFA(marge)}</div><div style="margin-top:6px;font-size:14px;color:var(--gray)">${tauxMarge}% de marge</div></div></div>
            <div class="stat-card"><div style="text-align:center;width:100%"><div class="stat-label">üí∞ Cr√©ances Clients</div><div class="stat-value" style="color:var(--warning)">${formatFCFA(impayees)}</div><div style="margin-top:6px;font-size:14px;color:var(--gray)">√Ä recevoir</div></div></div>
        </div>
        <div class="dashboard-grid">
            <div class="card"><h3>‚ö†Ô∏è Alertes Stock (${stockBas.length})</h3>${stockBas.length===0?'<p style="color:var(--gray)">Tous les stocks OK</p>':stockBas.map(p=>`<div class="alert-item">${ic.warning}<span>${p.nom}</span><span class="badge badge-warning">${p.stock}/${p.stockMin}</span></div>`).join('')}</div>
            <div class="card"><h3>üìã Derni√®res Ventes</h3>${data.ventes.slice(-3).reverse().map(v=>{const c=data.clients.find(x=>x.id===v.clientId);return`<div class="recent-item"><div><strong>${v.num}</strong><br><small>${c?.nom||'-'}</small></div><span class="${v.statut==='pay√©e'?'text-success':v.statut==='partielle'?'text-warning':'text-danger'}">${formatFCFA(v.total)}</span></div>`;}).join('')}</div>
            <div class="card"><h3>üí≥ Derniers Mouvements</h3>${data.tresorerie.slice(-3).reverse().map(t=>`<div class="recent-item"><div><strong>${t.desc}</strong><br><small>${formatDate(t.date)}</small></div><span class="${t.type==='entree'?'text-success':'text-danger'}">${t.type==='entree'?'+':'-'}${formatFCFA(t.montant)}</span></div>`).join('')}</div>
            <div class="card"><h3>üìä Statistiques</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div style="text-align:center;padding:12px;background:var(--light);border-radius:8px"><div style="font-size:20px;font-weight:700">${data.clients.length}</div><div style="font-size:12px;color:var(--gray)">Clients</div></div><div style="text-align:center;padding:12px;background:var(--light);border-radius:8px"><div style="font-size:20px;font-weight:700">${data.produits.length}</div><div style="font-size:12px;color:var(--gray)">Produits</div></div><div style="text-align:center;padding:12px;background:var(--light);border-radius:8px"><div style="font-size:20px;font-weight:700">${data.ventes.length}</div><div style="font-size:12px;color:var(--gray)">Ventes</div></div><div style="text-align:center;padding:12px;background:var(--light);border-radius:8px"><div style="font-size:20px;font-weight:700">${data.achats.length}</div><div style="font-size:12px;color:var(--gray)">Achats</div></div></div></div>
        </div>
    </div>`;
}

function pageClients() {
    const filtered = data.clients.filter(c=>c.nom.toLowerCase().includes(state.search.toLowerCase())||(c.code||'').toLowerCase().includes(state.search.toLowerCase())||c.telephone.includes(state.search));
    return `<div class="page">
        <div class="page-header"><h1 class="page-title">Clients</h1><div><button class="btn btn-success" onclick="excel.clients()">${ic.download} Excel</button> <button class="btn btn-primary" onclick="modalClient()">${ic.plus} Nouveau</button></div></div>
        <div class="search-bar">${ic.search}<input type="text" placeholder="Rechercher par nom, code ou t√©l√©phone..." value="${state.search}" oninput="state.search=this.value;render()"></div>
        <div class="table-box"><table><thead><tr><th>Code</th><th>Type</th><th>Nom / Raison sociale</th><th>T√©l√©phone</th><th>NINEA</th><th>Contact</th><th>Actions</th></tr></thead><tbody>
            ${filtered.map(c=>`<tr><td><code style="background:var(--light);padding:4px 8px;border-radius:4px">${c.code||'-'}</code></td><td>${getTypeBadge(c.type)}</td><td><strong>${c.nom}</strong></td><td>${c.telephone}</td><td>${c.ninea||'-'}</td><td>${c.contact||'-'}</td><td><button class="btn-icon btn-edit" onclick="modalClient('${c.id}')">${ic.edit}</button> <button class="btn-icon btn-delete" onclick="deleteClient('${c.id}')">${ic.delete}</button></td></tr>`).join('')}
        </tbody></table></div>
    </div>`;
}

function modalClient(id) {
    const c = id ? data.clients.find(x=>x.id===id) : {id:'',code:genCode('CLI'),nom:'',type:'particulier',telephone:'',email:'',adresse:'',ninea:'',contact:''};
    openModal(`<div class="modal-header"><h2>${id?'Modifier':'Nouveau'} Client</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>
        <div class="modal-body"><div class="form-grid">
            <div class="form-group"><label>Code Client</label><input type="text" id="cCode" value="${c.code||genCode('CLI')}" readonly style="background:var(--light)"></div>
            <div class="form-group"><label>Type *</label><select id="cType"><option value="particulier" ${c.type==='particulier'?'selected':''}>Particulier</option><option value="entreprise" ${c.type==='entreprise'?'selected':''}>Entreprise</option><option value="association" ${c.type==='association'?'selected':''}>Association</option></select></div>
            <div class="form-group full"><label>Nom / Raison sociale *</label><input type="text" id="cNom" value="${c.nom}"></div>
            <div class="form-group"><label>T√©l√©phone</label><input type="text" id="cTel" value="${c.telephone}"></div>
            <div class="form-group"><label>Email</label><input type="email" id="cEmail" value="${c.email||''}"></div>
            <div class="form-group full"><label>Adresse</label><input type="text" id="cAdresse" value="${c.adresse||''}"></div>
            <div class="form-group"><label>NINEA (entreprises)</label><input type="text" id="cNinea" value="${c.ninea||''}" placeholder="Num√©ro NINEA"></div>
            <div class="form-group"><label>Contact principal</label><input type="text" id="cContact" value="${c.contact||''}" placeholder="Nom - Fonction"></div>
        </div><div class="form-actions"><button class="btn btn-secondary" onclick="closeModal()">Annuler</button><button class="btn btn-primary" onclick="saveClient('${id}')">Enregistrer</button></div></div>`,'modal-lg');
}

function saveClient(id) {
    const nom = document.getElementById('cNom').value.trim();
    if(!nom) return toast.error('Le nom est obligatoire');
    const obj = {id: id||genId(), code: document.getElementById('cCode').value, nom, type: document.getElementById('cType').value, telephone: document.getElementById('cTel').value, email: document.getElementById('cEmail').value, adresse: document.getElementById('cAdresse').value, ninea: document.getElementById('cNinea').value, contact: document.getElementById('cContact').value};
    if(id) { data.clients = data.clients.map(c=>c.id===id?obj:c); } else { data.clients.push(obj); }
    toast.success('Client enregistr√©');
    closeModal();
}

function deleteClient(id) { if(confirm('Supprimer ce client?')) { data.clients = data.clients.filter(c=>c.id!==id); toast.success('Client supprim√©'); render(); }}

function pageFournisseurs() {
    const filtered = data.fournisseurs.filter(f=>f.nom.toLowerCase().includes(state.search.toLowerCase())||(f.code||'').toLowerCase().includes(state.search.toLowerCase()));
    return `<div class="page">
        <div class="page-header"><h1 class="page-title">Fournisseurs</h1><div><button class="btn btn-success" onclick="excel.fournisseurs()">${ic.download} Excel</button> <button class="btn btn-primary" onclick="modalFournisseur()">${ic.plus} Nouveau</button></div></div>
        <div class="search-bar">${ic.search}<input type="text" placeholder="Rechercher..." value="${state.search}" oninput="state.search=this.value;render()"></div>
        <div class="table-box"><table><thead><tr><th>Code</th><th>Type</th><th>Nom</th><th>T√©l√©phone</th><th>NINEA</th><th>Contact</th><th>Actions</th></tr></thead><tbody>
            ${filtered.map(f=>`<tr><td><code style="background:var(--light);padding:4px 8px;border-radius:4px">${f.code||'-'}</code></td><td>${getTypeBadge(f.type)}</td><td><strong>${f.nom}</strong></td><td>${f.telephone}</td><td>${f.ninea||'-'}</td><td>${f.contact||'-'}</td><td><button class="btn-icon btn-edit" onclick="modalFournisseur('${f.id}')">${ic.edit}</button> <button class="btn-icon btn-delete" onclick="deleteFournisseur('${f.id}')">${ic.delete}</button></td></tr>`).join('')}
        </tbody></table></div>
    </div>`;
}

function modalFournisseur(id) {
    const f = id ? data.fournisseurs.find(x=>x.id===id) : {id:'',code:genCode('FRN'),nom:'',type:'entreprise',telephone:'',adresse:'',ninea:'',contact:''};
    openModal(`<div class="modal-header"><h2>${id?'Modifier':'Nouveau'} Fournisseur</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>
        <div class="modal-body"><div class="form-grid">
            <div class="form-group"><label>Code</label><input type="text" id="fCode" value="${f.code||genCode('FRN')}" readonly style="background:var(--light)"></div>
            <div class="form-group"><label>Type</label><select id="fType"><option value="entreprise" ${f.type==='entreprise'?'selected':''}>Entreprise</option><option value="particulier" ${f.type==='particulier'?'selected':''}>Particulier</option></select></div>
            <div class="form-group full"><label>Nom *</label><input type="text" id="fNom" value="${f.nom}"></div>
            <div class="form-group"><label>T√©l√©phone</label><input type="text" id="fTel" value="${f.telephone}"></div>
            <div class="form-group"><label>NINEA</label><input type="text" id="fNinea" value="${f.ninea||''}"></div>
            <div class="form-group full"><label>Adresse</label><input type="text" id="fAdresse" value="${f.adresse||''}"></div>
            <div class="form-group full"><label>Contact</label><input type="text" id="fContact" value="${f.contact||''}" placeholder="Nom - Fonction"></div>
        </div><div class="form-actions"><button class="btn btn-secondary" onclick="closeModal()">Annuler</button><button class="btn btn-primary" onclick="saveFournisseur('${id}')">Enregistrer</button></div></div>`,'modal-lg');
}

function saveFournisseur(id) {
    const nom = document.getElementById('fNom').value.trim();
    if(!nom) return toast.error('Le nom est obligatoire');
    const obj = {id: id||genId(), code: document.getElementById('fCode').value, nom, type: document.getElementById('fType').value, telephone: document.getElementById('fTel').value, adresse: document.getElementById('fAdresse').value, ninea: document.getElementById('fNinea').value, contact: document.getElementById('fContact').value};
    if(id) { data.fournisseurs = data.fournisseurs.map(f=>f.id===id?obj:f); } else { data.fournisseurs.push(obj); }
    toast.success('Fournisseur enregistr√©'); closeModal();
}

function deleteFournisseur(id) { if(confirm('Supprimer?')) { data.fournisseurs = data.fournisseurs.filter(f=>f.id!==id); toast.success('Supprim√©'); render(); }}

function pageProduits() {
    const filtered = data.produits.filter(p=>p.nom.toLowerCase().includes(state.search.toLowerCase())||p.ref.toLowerCase().includes(state.search.toLowerCase()));
    return `<div class="page">
        <div class="page-header"><h1 class="page-title">Produits</h1><div><button class="btn btn-success" onclick="excel.produits()">${ic.download} Excel</button> <button class="btn btn-primary" onclick="modalProduit()">${ic.plus} Nouveau</button></div></div>
        <div class="search-bar">${ic.search}<input type="text" placeholder="Rechercher..." value="${state.search}" oninput="state.search=this.value;render()"></div>
        <div class="table-box"><table><thead><tr><th>R√©f</th><th>Nom</th><th>Cat√©gorie</th><th>P.Achat</th><th>P.Vente</th><th>Marge</th><th>Stock</th><th>Actions</th></tr></thead><tbody>
            ${filtered.map(p=>{const cat=data.categories.find(c=>c.id===p.catId);return`<tr class="${p.stock<=p.stockMin?'style="background:var(--warning-light)"':''}"><td><code>${p.ref}</code></td><td><strong>${p.nom}</strong></td><td>${cat?.nom||'-'}</td><td>${formatFCFA(p.prixAchat)}</td><td>${formatFCFA(p.prixVente)}</td><td class="text-success">${formatFCFA(p.prixVente-p.prixAchat)}</td><td><span class="badge ${p.stock<=p.stockMin?'badge-danger':'badge-success'}">${p.stock}</span></td><td><button class="btn-icon btn-edit" onclick="modalProduit('${p.id}')">${ic.edit}</button> <button class="btn-icon btn-delete" onclick="deleteProduit('${p.id}')">${ic.delete}</button></td></tr>`;}).join('')}
        </tbody></table></div>
    </div>`;
}

function modalProduit(id) {
    const p = id ? data.produits.find(x=>x.id===id) : {id:'',ref:'PRD'+String(data.produits.length+1).padStart(3,'0'),nom:'',catId:'',prixAchat:0,prixVente:0,stock:0,stockMin:5};
    openModal(`<div class="modal-header"><h2>${id?'Modifier':'Nouveau'} Produit</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>
        <div class="modal-body"><div class="form-grid">
            <div class="form-group"><label>R√©f√©rence *</label><input type="text" id="pRef" value="${p.ref}"></div>
            <div class="form-group"><label>Nom *</label><input type="text" id="pNom" value="${p.nom}"></div>
            <div class="form-group"><label>Cat√©gorie</label><select id="pCat"><option value="">--</option>${data.categories.map(c=>`<option value="${c.id}" ${p.catId===c.id?'selected':''}>${c.nom}</option>`).join('')}</select></div>
            <div class="form-group"><label>Prix Achat</label><input type="number" id="pPA" value="${p.prixAchat}"></div>
            <div class="form-group"><label>Prix Vente</label><input type="number" id="pPV" value="${p.prixVente}"></div>
            <div class="form-group"><label>Stock</label><input type="number" id="pStock" value="${p.stock}"></div>
            <div class="form-group"><label>Stock Min</label><input type="number" id="pStockMin" value="${p.stockMin}"></div>
        </div><div class="form-actions"><button class="btn btn-secondary" onclick="closeModal()">Annuler</button><button class="btn btn-primary" onclick="saveProduit('${id}')">Enregistrer</button></div></div>`);
}

function saveProduit(id) {
    const nom = document.getElementById('pNom').value.trim();
    const ref = document.getElementById('pRef').value.trim();
    if(!nom||!ref) return toast.error('Nom et r√©f√©rence obligatoires');
    const obj = {id:id||genId(),ref,nom,catId:document.getElementById('pCat').value,prixAchat:parseInt(document.getElementById('pPA').value)||0,prixVente:parseInt(document.getElementById('pPV').value)||0,stock:parseInt(document.getElementById('pStock').value)||0,stockMin:parseInt(document.getElementById('pStockMin').value)||0};
    if(id) { data.produits = data.produits.map(p=>p.id===id?obj:p); } else { data.produits.push(obj); }
    toast.success('Produit enregistr√©'); closeModal();
}

function deleteProduit(id) { if(confirm('Supprimer?')) { data.produits = data.produits.filter(p=>p.id!==id); toast.success('Supprim√©'); render(); }}

function pageVentes() {
    const filtered = filterByDate(data.ventes);
    const years = getYears();
    return `<div class="page">
        <div class="page-header"><h1 class="page-title">Ventes</h1><div><button class="btn btn-success" onclick="excel.ventes()">${ic.download} Excel</button> <button class="btn btn-primary" onclick="modalVente()">${ic.plus} Nouvelle Vente</button></div></div>
        <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
            <select style="padding:10px;border:2px solid var(--light);border-radius:8px" onchange="state.filterYear=this.value;render()"><option value="">Toutes ann√©es</option>${years.map(y=>`<option value="${y}" ${state.filterYear==y?'selected':''}>${y}</option>`).join('')}</select>
            <div style="display:flex;align-items:center;gap:8px"><span>Du:</span><input type="date" value="${state.filterDateStart}" onchange="state.filterDateStart=this.value;render()" style="padding:8px;border:2px solid var(--light);border-radius:8px"></div>
            <div style="display:flex;align-items:center;gap:8px"><span>Au:</span><input type="date" value="${state.filterDateEnd}" onchange="state.filterDateEnd=this.value;render()" style="padding:8px;border:2px solid var(--light);border-radius:8px"></div>
        </div>
        <div class="table-box"><table><thead><tr><th>N¬∞</th><th>Date</th><th>Client</th><th>Total</th><th>Pay√©</th><th>Reste</th><th>Statut</th><th>Actions</th></tr></thead><tbody>
            ${filtered.slice().reverse().map(v=>{const c=data.clients.find(x=>x.id===v.clientId);const reste=v.total-v.paye;return`<tr><td><code>${v.num}</code></td><td>${formatDate(v.date)}</td><td><strong>${c?.nom||'-'}</strong></td><td>${formatFCFA(v.total)}</td><td class="text-success">${formatFCFA(v.paye)}</td><td class="${reste>0?'text-danger':''}" style="font-weight:600">${formatFCFA(reste)}</td><td><span class="badge ${v.statut==='pay√©e'?'badge-success':v.statut==='partielle'?'badge-warning':'badge-danger'}">${v.statut}</span></td><td>${reste>0?`<button class="btn btn-sm" style="background:var(--success);color:white" onclick="modalPaiement('vente','${v.id}')">üí∞ Paiement</button> `:''}  <button class="btn btn-sm btn-secondary" onclick="pdf.facture(data.ventes.find(x=>x.id==='${v.id}'))">${ic.pdf} PDF</button> <button class="btn-icon btn-edit" onclick="modalVente('${v.id}')">${ic.edit}</button></td></tr>`;}).join('')}
        </tbody></table></div>
    </div>`;
}

function modalVente() {
    openModal(`<div class="modal-header"><h2>Nouvelle Vente</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>
        <div class="modal-body">
            <div class="form-grid">
                <div class="form-group"><label>Client *</label><select id="vClient"><option value="">-- S√©lectionner --</option>${data.clients.map(c=>`<option value="${c.id}">${c.nom}</option>`).join('')}</select></div>
                <div class="form-group"><label>Date</label><input type="date" id="vDate" value="${today()}"></div>
            </div>
            <h4 style="margin:20px 0 10px">Produits</h4>
            <div id="vLignes"></div>
            <button class="btn btn-sm btn-secondary" onclick="addVenteLigne()">${ic.plus} Ajouter produit</button>
            <div style="margin-top:20px;padding:16px;background:var(--light);border-radius:8px;display:flex;justify-content:space-between;align-items:center">
                <div><strong>Total:</strong> <span id="vTotal" style="font-size:24px;color:var(--primary);font-weight:700">0 FCFA</span></div>
                <div class="form-group" style="margin:0;width:200px"><label>Montant pay√©</label><input type="number" id="vPaye" value="0" onchange="calcVenteTotal()"></div>
            </div>
            <div class="form-actions"><button class="btn btn-secondary" onclick="closeModal()">Annuler</button><button class="btn btn-primary" onclick="saveVente()">Enregistrer</button></div>
        </div>`, 'modal-lg');
    setTimeout(()=>{addVenteLigne();},100);
}

let venteLignes = [];
function addVenteLigne() {
    venteLignes.push({prodId:'',qte:1,pu:0});
    renderVenteLignes();
}
function removeVenteLigne(i) { venteLignes.splice(i,1); renderVenteLignes(); }
function updateVenteLigne(i,field,val) {
    venteLignes[i][field] = val;
    if(field==='prodId') { const p = data.produits.find(x=>x.id===val); if(p) venteLignes[i].pu = p.prixVente; }
    renderVenteLignes();
}
function renderVenteLignes() {
    document.getElementById('vLignes').innerHTML = `<table style="width:100%"><thead><tr><th>Produit</th><th>Qt√©</th><th>Prix Unit.</th><th>Total</th><th></th></tr></thead><tbody>
        ${venteLignes.map((l,i)=>`<tr><td><select onchange="updateVenteLigne(${i},'prodId',this.value)" style="width:100%;padding:8px;border:2px solid var(--light);border-radius:6px"><option value="">--</option>${data.produits.map(p=>`<option value="${p.id}" ${l.prodId===p.id?'selected':''}>${p.nom} (${p.stock})</option>`).join('')}</select></td><td><input type="number" min="1" value="${l.qte}" onchange="updateVenteLigne(${i},'qte',parseInt(this.value)||1)" style="width:80px;padding:8px;border:2px solid var(--light);border-radius:6px"></td><td><input type="number" value="${l.pu}" onchange="updateVenteLigne(${i},'pu',parseInt(this.value)||0)" style="width:100px;padding:8px;border:2px solid var(--light);border-radius:6px"></td><td><strong>${formatFCFA(l.qte*l.pu)}</strong></td><td><button class="btn-icon btn-delete" onclick="removeVenteLigne(${i})">${ic.delete}</button></td></tr>`).join('')}
    </tbody></table>`;
    calcVenteTotal();
}
function calcVenteTotal() {
    const total = venteLignes.reduce((s,l)=>s+(l.qte*l.pu),0);
    document.getElementById('vTotal').textContent = formatFCFA(total);
}
function saveVente() {
    const clientId = document.getElementById('vClient').value;
    if(!clientId) return toast.error('S√©lectionnez un client');
    const lignes = venteLignes.filter(l=>l.prodId);
    if(lignes.length===0) return toast.error('Ajoutez au moins un produit');
    const total = lignes.reduce((s,l)=>s+(l.qte*l.pu),0);
    const paye = parseInt(document.getElementById('vPaye').value)||0;
    const statut = paye>=total?'pay√©e':(paye>0?'partielle':'impay√©e');
    const year = new Date().getFullYear();
    const num = 'VTE-' + year + '-' + String(data.ventes.filter(v=>v.num.includes(year)).length+1).padStart(3,'0');
    const vente = {id:genId(),num,date:document.getElementById('vDate').value,clientId,lignes,total,paye,statut,paiements:paye>0?[{date:document.getElementById('vDate').value,montant:paye,mode:'esp√®ces'}]:[]};
    data.ventes.push(vente);
    lignes.forEach(l=>{ data.produits = data.produits.map(p=>p.id===l.prodId?{...p,stock:p.stock-l.qte}:p); });
    if(paye>0) { data.tresorerie.push({id:genId(),date:vente.date,type:'entree',cat:'Vente',desc:'Encaissement '+num,montant:paye,mode:'esp√®ces'}); }
    venteLignes = [];
    toast.success('Vente enregistr√©e!'); closeModal();
}

// ========== MODAL PAIEMENT ==========
function modalPaiement(type, id) {
    const item = type === 'vente' ? data.ventes.find(v=>v.id===id) : data.achats.find(a=>a.id===id);
    const reste = item.total - item.paye;
    const title = type === 'vente' ? 'Encaissement' : 'Paiement Fournisseur';
    openModal(`<div class="modal-header"><h2>üí∞ ${title}</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>
        <div class="modal-body">
            <div style="background:var(--light);padding:20px;border-radius:8px;margin-bottom:20px">
                <div style="display:flex;justify-content:space-between;margin-bottom:10px"><span>Document:</span><strong>${item.num}</strong></div>
                <div style="display:flex;justify-content:space-between;margin-bottom:10px"><span>Total:</span><strong>${formatFCFA(item.total)}</strong></div>
                <div style="display:flex;justify-content:space-between;margin-bottom:10px"><span>D√©j√† pay√©:</span><strong class="text-success">${formatFCFA(item.paye)}</strong></div>
                <div style="display:flex;justify-content:space-between;border-top:2px solid var(--white);padding-top:10px"><span style="font-weight:600">Reste √† payer:</span><strong class="text-danger" style="font-size:20px">${formatFCFA(reste)}</strong></div>
            </div>
            <div class="form-grid">
                <div class="form-group"><label>Date du paiement</label><input type="date" id="pDate" value="${today()}"></div>
                <div class="form-group"><label>Montant (FCFA) *</label><input type="number" id="pMontant" value="${reste}" max="${reste}"></div>
                <div class="form-group full"><label>Mode de paiement</label><select id="pMode"><option value="esp√®ces">Esp√®ces</option><option value="virement">Virement bancaire</option><option value="ch√®que">Ch√®que</option><option value="mobile">Mobile Money</option></select></div>
            </div>
            <div class="form-actions"><button class="btn btn-secondary" onclick="closeModal()">Annuler</button><button class="btn" style="background:var(--success);color:white" onclick="savePaiement('${type}','${id}')">‚úì Enregistrer le paiement</button></div>
        </div>`);
}

function savePaiement(type, id) {
    const montant = parseInt(document.getElementById('pMontant').value) || 0;
    if (montant <= 0) return toast.error('Montant invalide');
    const date = document.getElementById('pDate').value;
    const mode = document.getElementById('pMode').value;
    
    if (type === 'vente') {
        data.ventes = data.ventes.map(v => {
            if (v.id === id) {
                const newPaye = v.paye + montant;
                const statut = newPaye >= v.total ? 'pay√©e' : 'partielle';
                return { ...v, paye: newPaye, statut, paiements: [...(v.paiements || []), {date, montant, mode}] };
            }
            return v;
        });
        const vente = data.ventes.find(v => v.id === id);
        data.tresorerie.push({id:genId(), date, type:'entree', cat:'Vente', desc:'Encaissement '+vente.num, montant, mode});
    } else {
        data.achats = data.achats.map(a => {
            if (a.id === id) {
                const newPaye = a.paye + montant;
                const statut = newPaye >= a.total ? 'pay√©' : 'partiel';
                return { ...a, paye: newPaye, statut, paiements: [...(a.paiements || []), {date, montant, mode}] };
            }
            return a;
        });
        const achat = data.achats.find(a => a.id === id);
        data.tresorerie.push({id:genId(), date, type:'sortie', cat:'Achat', desc:'Paiement '+achat.num, montant, mode});
    }
    toast.success('Paiement enregistr√©!'); closeModal();
}

function pageAchats() {
    const filtered = filterByDate(data.achats);
    const years = getYears();
    return `<div class="page">
        <div class="page-header"><h1 class="page-title">Achats</h1><div><button class="btn btn-success" onclick="excel.achats()">${ic.download} Excel</button> <button class="btn btn-primary" onclick="modalAchat()">${ic.plus} Nouvel Achat</button></div></div>
        <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center">
            <select style="padding:10px;border:2px solid var(--light);border-radius:8px" onchange="state.filterYear=this.value;render()"><option value="">Toutes ann√©es</option>${years.map(y=>`<option value="${y}" ${state.filterYear==y?'selected':''}>${y}</option>`).join('')}</select>
            <div style="display:flex;align-items:center;gap:8px"><span>Du:</span><input type="date" value="${state.filterDateStart}" onchange="state.filterDateStart=this.value;render()" style="padding:8px;border:2px solid var(--light);border-radius:8px"></div>
            <div style="display:flex;align-items:center;gap:8px"><span>Au:</span><input type="date" value="${state.filterDateEnd}" onchange="state.filterDateEnd=this.value;render()" style="padding:8px;border:2px solid var(--light);border-radius:8px"></div>
        </div>
        <div class="table-box"><table><thead><tr><th>N¬∞</th><th>Date</th><th>Fournisseur</th><th>Total</th><th>Pay√©</th><th>Reste</th><th>Statut</th><th>Actions</th></tr></thead><tbody>
            ${filtered.slice().reverse().map(a=>{const f=data.fournisseurs.find(x=>x.id===a.fournId);const reste=a.total-a.paye;return`<tr><td><code>${a.num}</code></td><td>${formatDate(a.date)}</td><td><strong>${f?.nom||'-'}</strong></td><td>${formatFCFA(a.total)}</td><td class="text-success">${formatFCFA(a.paye)}</td><td class="${reste>0?'text-danger':''}" style="font-weight:600">${formatFCFA(reste)}</td><td><span class="badge ${a.statut==='pay√©'?'badge-success':a.statut==='partiel'?'badge-warning':'badge-danger'}">${a.statut}</span></td><td>${reste>0?`<button class="btn btn-sm" style="background:var(--warning);color:white" onclick="modalPaiement('achat','${a.id}')">üí∞ Payer</button>`:''}</td></tr>`;}).join('')}
        </tbody></table></div>
    </div>`;
}

function modalAchat() {
    openModal(`<div class="modal-header"><h2>Nouvel Achat</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>
        <div class="modal-body">
            <div class="form-grid">
                <div class="form-group"><label>Fournisseur *</label><select id="aFourn"><option value="">-- S√©lectionner --</option>${data.fournisseurs.map(f=>`<option value="${f.id}">${f.nom}</option>`).join('')}</select></div>
                <div class="form-group"><label>Date</label><input type="date" id="aDate" value="${today()}"></div>
            </div>
            <h4 style="margin:20px 0 10px">Produits</h4>
            <div id="aLignes"></div>
            <button class="btn btn-sm btn-secondary" onclick="addAchatLigne()">${ic.plus} Ajouter produit</button>
            <div style="margin-top:20px;padding:16px;background:var(--light);border-radius:8px;display:flex;justify-content:space-between;align-items:center">
                <div><strong>Total:</strong> <span id="aTotal" style="font-size:24px;color:var(--danger);font-weight:700">0 FCFA</span></div>
                <div class="form-group" style="margin:0;width:200px"><label>Montant pay√©</label><input type="number" id="aPaye" value="0" onchange="calcAchatTotal()"></div>
            </div>
            <div class="form-actions"><button class="btn btn-secondary" onclick="closeModal()">Annuler</button><button class="btn btn-primary" onclick="saveAchat()">Enregistrer</button></div>
        </div>`, 'modal-lg');
    setTimeout(()=>{addAchatLigne();},100);
}

let achatLignes = [];
function addAchatLigne() { achatLignes.push({prodId:'',qte:1,pu:0}); renderAchatLignes(); }
function removeAchatLigne(i) { achatLignes.splice(i,1); renderAchatLignes(); }
function updateAchatLigne(i,field,val) {
    achatLignes[i][field] = val;
    if(field==='prodId') { const p = data.produits.find(x=>x.id===val); if(p) achatLignes[i].pu = p.prixAchat; }
    renderAchatLignes();
}
function renderAchatLignes() {
    document.getElementById('aLignes').innerHTML = `<table style="width:100%"><thead><tr><th>Produit</th><th>Qt√©</th><th>Prix Unit.</th><th>Total</th><th></th></tr></thead><tbody>
        ${achatLignes.map((l,i)=>`<tr><td><select onchange="updateAchatLigne(${i},'prodId',this.value)" style="width:100%;padding:8px;border:2px solid var(--light);border-radius:6px"><option value="">--</option>${data.produits.map(p=>`<option value="${p.id}" ${l.prodId===p.id?'selected':''}>${p.nom}</option>`).join('')}</select></td><td><input type="number" min="1" value="${l.qte}" onchange="updateAchatLigne(${i},'qte',parseInt(this.value)||1)" style="width:80px;padding:8px;border:2px solid var(--light);border-radius:6px"></td><td><input type="number" value="${l.pu}" onchange="updateAchatLigne(${i},'pu',parseInt(this.value)||0)" style="width:100px;padding:8px;border:2px solid var(--light);border-radius:6px"></td><td><strong>${formatFCFA(l.qte*l.pu)}</strong></td><td><button class="btn-icon btn-delete" onclick="removeAchatLigne(${i})">${ic.delete}</button></td></tr>`).join('')}
    </tbody></table>`;
    calcAchatTotal();
}
function calcAchatTotal() {
    const total = achatLignes.reduce((s,l)=>s+(l.qte*l.pu),0);
    document.getElementById('aTotal').textContent = formatFCFA(total);
}
function saveAchat() {
    const fournId = document.getElementById('aFourn').value;
    if(!fournId) return toast.error('S√©lectionnez un fournisseur');
    const lignes = achatLignes.filter(l=>l.prodId);
    if(lignes.length===0) return toast.error('Ajoutez au moins un produit');
    const total = lignes.reduce((s,l)=>s+(l.qte*l.pu),0);
    const paye = parseInt(document.getElementById('aPaye').value)||0;
    const statut = paye>=total?'pay√©':(paye>0?'partiel':'impay√©');
    const num = 'ACH-' + String(data.achats.length+1).padStart(3,'0');
    const achat = {id:genId(),num,date:document.getElementById('aDate').value,fournId,lignes,total,paye,statut};
    data.achats.push(achat);
    lignes.forEach(l=>{ data.produits = data.produits.map(p=>p.id===l.prodId?{...p,stock:p.stock+l.qte}:p); });
    if(paye>0) { data.tresorerie.push({id:genId(),date:achat.date,type:'sortie',cat:'Achat',desc:'Paiement '+num,montant:paye,mode:'esp√®ces'}); }
    achatLignes = [];
    toast.success('Achat enregistr√©!'); closeModal();
}

function pageTresorerie() {
    const entrees = data.tresorerie.filter(t=>t.type==='entree').reduce((s,t)=>s+t.montant,0);
    const sorties = data.tresorerie.filter(t=>t.type==='sortie').reduce((s,t)=>s+t.montant,0);
    const solde = entrees - sorties;
    return `<div class="page">
        <div class="page-header"><h1 class="page-title">Tr√©sorerie</h1><div><button class="btn btn-success" onclick="excel.tresorerie()">${ic.download} Excel</button> <button class="btn btn-primary" onclick="modalTresorerie()">${ic.plus} Nouveau Mouvement</button></div></div>
        <div class="tresorerie-summary">
            <div class="summary-card entree"><div class="summary-label">Total Entr√©es</div><div class="summary-value">${formatFCFA(entrees)}</div></div>
            <div class="summary-card sortie"><div class="summary-label">Total Sorties</div><div class="summary-value">${formatFCFA(sorties)}</div></div>
            <div class="summary-card solde"><div class="summary-label">Solde</div><div class="summary-value">${formatFCFA(solde)}</div></div>
        </div>
        <div class="table-box"><table><thead><tr><th>Date</th><th>Type</th><th>Cat√©gorie</th><th>Description</th><th>Mode</th><th>Montant</th></tr></thead><tbody>
            ${data.tresorerie.slice().reverse().map(t=>`<tr><td>${formatDate(t.date)}</td><td><span class="badge ${t.type==='entree'?'badge-success':'badge-danger'}">${t.type==='entree'?'‚Üë Entr√©e':'‚Üì Sortie'}</span></td><td>${t.cat}</td><td>${t.desc}</td><td>${t.mode}</td><td class="${t.type==='entree'?'text-success':'text-danger'}">${t.type==='entree'?'+':'-'}${formatFCFA(t.montant)}</td></tr>`).join('')}
        </tbody></table></div>
    </div>`;
}

function modalTresorerie() {
    openModal(`<div class="modal-header"><h2>Nouveau Mouvement</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>
        <div class="modal-body"><div class="form-grid">
            <div class="form-group"><label>Date</label><input type="date" id="tDate" value="${today()}"></div>
            <div class="form-group"><label>Type *</label><select id="tType"><option value="entree">Entr√©e</option><option value="sortie">Sortie</option></select></div>
            <div class="form-group"><label>Cat√©gorie</label><select id="tCat"><option value="">--</option><option>Vente</option><option>Achat</option><option>Salaire</option><option>Loyer</option><option>√âlectricit√©</option><option>Transport</option><option>Apport</option><option>Autre</option></select></div>
            <div class="form-group"><label>Mode de paiement</label><select id="tMode"><option value="esp√®ces">Esp√®ces</option><option value="virement">Virement</option><option value="ch√®que">Ch√®que</option><option value="mobile">Mobile Money</option></select></div>
            <div class="form-group full"><label>Description *</label><input type="text" id="tDesc"></div>
            <div class="form-group"><label>Montant (FCFA) *</label><input type="number" id="tMontant" value="0"></div>
        </div><div class="form-actions"><button class="btn btn-secondary" onclick="closeModal()">Annuler</button><button class="btn btn-primary" onclick="saveTresorerie()">Enregistrer</button></div></div>`);
}

function saveTresorerie() {
    const desc = document.getElementById('tDesc').value.trim();
    const montant = parseInt(document.getElementById('tMontant').value)||0;
    if(!desc) return toast.error('Description obligatoire');
    if(montant<=0) return toast.error('Montant invalide');
    const mvt = {id:genId(),date:document.getElementById('tDate').value,type:document.getElementById('tType').value,cat:document.getElementById('tCat').value,desc,montant,mode:document.getElementById('tMode').value};
    data.tresorerie.push(mvt);
    toast.success('Mouvement enregistr√©!'); closeModal();
}

function pageRapports() {
    return `<div class="page">
        <h1 class="page-title">üìä Rapports Excel</h1>
        <p style="color:var(--gray);margin-bottom:24px">Exportez vos donn√©es au format Excel pour analyse ou archivage</p>
        <div class="rapports-grid">
            <div class="rapport-card" onclick="excel.rapportComplet()">${ic.rapports}<h4>üìà Rapport Complet</h4><p>R√©sum√© + toutes les donn√©es</p></div>
            <div class="rapport-card" onclick="excel.clients()">${ic.clients}<h4>üë• Liste Clients</h4><p>Tous les clients</p></div>
            <div class="rapport-card" onclick="excel.fournisseurs()">${ic.fournisseurs}<h4>üöö Liste Fournisseurs</h4><p>Tous les fournisseurs</p></div>
            <div class="rapport-card" onclick="excel.produits()">${ic.produits}<h4>üì¶ Inventaire Produits</h4><p>Stock et valeurs</p></div>
            <div class="rapport-card" onclick="excel.ventes()">${ic.ventes}<h4>üí∞ Journal des Ventes</h4><p>Toutes les ventes</p></div>
            <div class="rapport-card" onclick="excel.achats()">${ic.achats}<h4>üõí Journal des Achats</h4><p>Tous les achats</p></div>
            <div class="rapport-card" onclick="excel.tresorerie()">${ic.tresorerie}<h4>üí≥ Mouvements Tr√©sorerie</h4><p>Entr√©es et sorties</p></div>
            <div class="rapport-card" onclick="excel.employes()">${ic.employes}<h4>üëî Liste Employ√©s</h4><p>Personnel et salaires</p></div>
        </div>
    </div>`;
}

function pageEmployes() {
    return `<div class="page">
        <div class="page-header"><h1 class="page-title">Employ√©s</h1><div><button class="btn btn-success" onclick="excel.employes()">${ic.download} Excel</button> <button class="btn btn-primary" onclick="modalEmploye()">${ic.plus} Nouveau</button></div></div>
        <div class="table-box"><table><thead><tr><th>Matricule</th><th>Nom</th><th>Pr√©nom</th><th>Poste</th><th>Salaire</th><th>Actions</th></tr></thead><tbody>
            ${data.employes.map(e=>`<tr><td><code>${e.matricule}</code></td><td><strong>${e.nom}</strong></td><td>${e.prenom}</td><td>${e.poste}</td><td>${formatFCFA(e.salaire)}</td><td><button class="btn-icon btn-edit" onclick="modalEmploye('${e.id}')">${ic.edit}</button> <button class="btn-icon btn-delete" onclick="deleteEmploye('${e.id}')">${ic.delete}</button></td></tr>`).join('')}
        </tbody></table></div>
    </div>`;
}

function modalEmploye(id) {
    const e = id ? data.employes.find(x=>x.id===id) : {id:'',matricule:'EMP'+String(data.employes.length+1).padStart(3,'0'),nom:'',prenom:'',poste:'',salaire:0};
    openModal(`<div class="modal-header"><h2>${id?'Modifier':'Nouvel'} Employ√©</h2><button class="modal-close" onclick="closeModal()">√ó</button></div>
        <div class="modal-body"><div class="form-grid">
            <div class="form-group"><label>Matricule</label><input type="text" id="eMatricule" value="${e.matricule}"></div>
            <div class="form-group"><label>Nom *</label><input type="text" id="eNom" value="${e.nom}"></div>
            <div class="form-group"><label>Pr√©nom</label><input type="text" id="ePrenom" value="${e.prenom}"></div>
            <div class="form-group"><label>Poste</label><input type="text" id="ePoste" value="${e.poste}"></div>
            <div class="form-group"><label>Salaire (FCFA)</label><input type="number" id="eSalaire" value="${e.salaire}"></div>
        </div><div class="form-actions"><button class="btn btn-secondary" onclick="closeModal()">Annuler</button><button class="btn btn-primary" onclick="saveEmploye('${id}')">Enregistrer</button></div></div>`);
}

function saveEmploye(id) {
    const nom = document.getElementById('eNom').value.trim();
    if(!nom) return toast.error('Nom obligatoire');
    const obj = {id:id||genId(),matricule:document.getElementById('eMatricule').value,nom,prenom:document.getElementById('ePrenom').value,poste:document.getElementById('ePoste').value,salaire:parseInt(document.getElementById('eSalaire').value)||0};
    if(id) { data.employes = data.employes.map(e=>e.id===id?obj:e); } else { data.employes.push(obj); }
    toast.success('Employ√© enregistr√©'); closeModal();
}

function deleteEmploye(id) { if(confirm('Supprimer?')) { data.employes = data.employes.filter(e=>e.id!==id); toast.success('Supprim√©'); render(); }}

// ========== INIT ==========
render();
</script>
</body>
</html>
